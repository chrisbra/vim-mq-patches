Problem: https://groups.google.com/d/msg/vim_dev/Kt_PW54CMP0/8u_WwYErJ2cJ

When a fold ends with the last line of the buffer, this can cause various errors (E315).
So check, that the last line is actually valid.

# HG changeset patch
# Parent f2e195d6a701b46d2df967d59add98fd37d57f95
diff --git a/src/fold.c b/src/fold.c
--- a/src/fold.c
+++ b/src/fold.c
@@ -234,6 +234,8 @@ hasFoldingWin(win, lnum, firstp, lastp, 
 	return FALSE;
     }
 
+    if (last > win->w_buffer->b_ml.ml_line_count)
+	last = win->w_buffer->b_ml.ml_line_count;
     if (lastp != NULL)
 	*lastp = last;
     if (firstp != NULL)
